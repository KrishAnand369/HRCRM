<!-- modal.html -->
<div class="modal fade" id="chatModal" tabindex="-1" role="dialog" aria-labelledby="chatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chatModalLabel">Private Chat with {{ other_user.username }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Chat log -->
                <div id="chat-log">
                    {% for message in messages %}
                        <div class="message {% if message.sender == request.user %}message-right{% else %}message-left{% endif %}">
                            <div class="message-content">
                                <strong>{{ message.sender.username }}</strong>: {{ message.message }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <!-- Chat input and send button -->
                <div class="chat-input-container">
                    <input type="text" id="chat-message-input" class="form-control" placeholder="Type your message...">
                    <button id="chat-message-submit" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles for the modal -->
<style>
    /* Chat log container */
    #chat-log {
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    /* Message styling */
    .message {
        display: flex;
        margin-bottom: 10px;
    }

    .message-content {
        padding: 10px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
    }

    /* Messages from the current user (right side) */
    .message-right {
        justify-content: flex-end;
    }

    .message-right .message-content {
        background-color: #007bff;
        color: white;
    }

    /* Messages from the other user (left side) */
    .message-left {
        justify-content: flex-start;
    }

    .message-left .message-content {
        background-color: #e9ecef;
        color: black;
    }

    /* Chat input container */
    .chat-input-container {
        display: flex;
        gap: 10px;
        width: 100%;
    }

    /* Input field */
    #chat-message-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    /* Send button */
    #chat-message-submit {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
    }

    #chat-message-submit:hover {
        background-color: #0056b3;
    }
</style>

<!-- Scripts for the modal -->
<script>
    // Initialize WebSocket connection when the modal is shown
    $('#chatModal').on('shown.bs.modal', function () {
        const roomName = "{{ room.name }}";
        const chatSocket = new WebSocket(
            `ws://${window.location.host}/ws/chat/${roomName}/`
        );

        // Debugging: Log WebSocket connection status
        chatSocket.onopen = function (e) {
            console.log('WebSocket connection established');
        };

        chatSocket.onmessage = function (e) {
            console.log('Message received:', e.data);  // Debugging
            const data = JSON.parse(e.data);
            const messageElement = document.createElement('div');

            // Determine message alignment based on sender
            if (data.sender === "{{ request.user.username }}") {
                messageElement.className = 'message message-right';
            } else {
                messageElement.className = 'message message-left';
            }

            // Add message content
            messageElement.innerHTML = `
                <div class="message-content">
                    <strong>${data.sender}</strong>: ${data.message}
                </div>
            `;

            // Append message to chat log
            document.querySelector('#chat-log').appendChild(messageElement);

            // Scroll to the bottom of the chat log
            const chatLog = document.querySelector('#chat-log');
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        chatSocket.onclose = function (e) {
            console.error('WebSocket connection closed unexpectedly');
        };

        chatSocket.onerror = function (e) {
            console.error('WebSocket error:', e);
        };

        // Send message when the Send button is clicked
        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInput = document.querySelector('#chat-message-input');
            const message = messageInput.value;

            if (message.trim() === "") {
                console.error('Message is empty');
                return;
            }

            if (chatSocket.readyState === WebSocket.OPEN) {
                console.log('Sending message:', message);  // Debugging
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'sender': "{{ request.user.username }}"
                }));
                messageInput.value = '';
            } else {
                console.error('WebSocket is not open.');
            }
        };

        // Send message when Enter key is pressed
        document.querySelector('#chat-message-input').onkeyup = function (e) {
            if (e.keyCode === 13) {  // Enter key
                document.querySelector('#chat-message-submit').click();
            }
        };
    });
</script>